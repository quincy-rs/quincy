name: Publish release

on:
  release:
    types: [created]

jobs:
  publish-crate:
    name: Publish crate

    runs-on: ubuntu-latest

    environment: release
    permissions:
      id-token: write

    steps:
      - uses: actions/checkout@v4
        name: Checkout repository
      - uses: dtolnay/rust-toolchain@stable
        name: Set up toolchain
      - uses: Swatinem/rust-cache@v2
        name: Cache toolchain and dependencies
      - uses: rust-lang/crates-io-auth-action@v1
        id: auth
        name: Authenticate to crates.io (trusted publishing)
      - name: Verify all crates can be published (dry-run)
        run: cargo publish --locked --workspace --exclude quincy-tests --dry-run
      - name: Publish crates to crates.io
        run: cargo publish --locked --workspace --exclude quincy-tests
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}

  build-linux:
    name: Build Linux

    runs-on: ubuntu-latest
    container: quay.io/pypa/manylinux_2_28_x86_64

    steps:
      - uses: actions/checkout@v4
        name: Checkout repository
      - uses: dtolnay/rust-toolchain@stable
        name: Set up toolchain
      - uses: Swatinem/rust-cache@v2
        name: Cache toolchain and dependencies
      - name: Build x86_64 Linux binaries
        run: |
          cargo build --release --workspace --features jemalloc
          mkdir -p release
          cp target/release/quincy-client release/
          cp target/release/quincy-server release/
          cp target/release/quincy-users release/
          cp target/release/quincy-client-gui release/
          cp target/release/quincy-client-daemon release/
      - uses: actions/upload-artifact@v4
        name: Upload build artifacts
        with:
          name: linux-binaries
          path: release/

  package-linux:
    name: Package Linux

    runs-on: ubuntu-latest
    needs: build-linux

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        name: Checkout repository
      - uses: dtolnay/rust-toolchain@stable
        name: Set up toolchain
      - uses: Swatinem/rust-cache@v2
        name: Cache cargo-packager
        with:
          cache-targets: false
          cache-directories: ~/.cargo/bin
      - uses: actions/download-artifact@v4
        name: Download build artifacts
        with:
          name: linux-binaries
          path: target/release/
      - name: Make binaries executable
        run: chmod +x target/release/*
      - name: Create tarball
        run: |
          mkdir -p release
          cp target/release/* release/
          tar zcf quincy-${{ github.ref_name }}-linux-x86_64.tar.gz -C release .
      - name: Install AppImage dependencies
        run: sudo apt-get update && sudo apt-get install -y libfuse2
      - name: Install cargo-packager
        run: cargo install cargo-packager --locked
      - name: Inject version into packager config
        run: |
          VERSION=$(cargo metadata --format-version 1 --no-deps | jq -r '.packages[] | select(.name=="quincy-gui") | .version')
          sed -i "s/version = \"0.0.0\"/version = \"$VERSION\"/" packager.linux.toml
      - name: Package Linux installers
        run: cargo packager --release -c packager.linux.toml
        env:
          SKIP_BUILD: "1"
      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          mv quincy-${{ github.ref_name }}-linux-x86_64.tar.gz artifacts/
          mv target/release/*.deb artifacts/quincy-${{ github.ref_name }}-linux-x86_64.deb
          mv target/release/*.AppImage artifacts/quincy-${{ github.ref_name }}-linux-x86_64.AppImage
      - uses: softprops/action-gh-release@v1
        name: Add artifacts to release
        with:
          files: artifacts/*

  build-macos:
    name: Build macOS

    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4
        name: Checkout repository
      - uses: dtolnay/rust-toolchain@stable
        name: Set up toolchain
      - uses: Swatinem/rust-cache@v2
        name: Cache toolchain and dependencies
      - name: Build arm64 macOS binaries
        run: |
          cargo build --release --workspace --features jemalloc
          mkdir -p release
          cp target/release/quincy-client release/
          cp target/release/quincy-server release/
          cp target/release/quincy-users release/
          cp target/release/quincy-client-gui release/
          cp target/release/quincy-client-daemon release/
      - uses: actions/upload-artifact@v4
        name: Upload build artifacts
        with:
          name: macos-binaries
          path: release/

  package-macos:
    name: Package macOS

    runs-on: macos-latest
    needs: build-macos

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        name: Checkout repository
      - uses: dtolnay/rust-toolchain@stable
        name: Set up toolchain
      - uses: Swatinem/rust-cache@v2
        name: Cache cargo-packager
        with:
          cache-targets: false
          cache-directories: ~/.cargo/bin
      - uses: actions/download-artifact@v4
        name: Download build artifacts
        with:
          name: macos-binaries
          path: target/release/
      - name: Make binaries executable
        run: chmod +x target/release/*
      - name: Create tarball
        run: |
          mkdir -p release
          cp target/release/* release/
          tar zcf quincy-${{ github.ref_name }}-macos-arm64.tar.gz -C release .
      - name: Install cargo-packager
        run: cargo install cargo-packager --locked
      - name: Inject version into packager config
        run: |
          VERSION=$(cargo metadata --format-version 1 --no-deps | jq -r '.packages[] | select(.name=="quincy-gui") | .version')
          sed -i '' "s/version = \"0.0.0\"/version = \"$VERSION\"/" packager.macos.toml
      - name: Package macOS installer
        run: cargo packager --release -c packager.macos.toml
        env:
          SKIP_BUILD: "1"
      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          mv quincy-${{ github.ref_name }}-macos-arm64.tar.gz artifacts/
          mv target/release/*.dmg artifacts/quincy-${{ github.ref_name }}-macos-arm64.dmg
      - uses: softprops/action-gh-release@v1
        name: Add artifacts to release
        with:
          files: artifacts/*

  build-windows:
    name: Build Windows

    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
        name: Checkout repository
      - uses: dtolnay/rust-toolchain@stable
        name: Set up toolchain
      - uses: Swatinem/rust-cache@v2
        name: Cache toolchain and dependencies
      - uses: ilammy/setup-nasm@v1
        name: Install NASM
      - name: Build x86_64 Windows binaries
        run: |
          cargo build --release --workspace
          mkdir ./release
          cp target/release/quincy-client.exe release/
          cp target/release/quincy-server.exe release/
          cp target/release/quincy-users.exe release/
          cp target/release/quincy-client-gui.exe release/
          cp target/release/quincy-client-daemon.exe release/
      - uses: actions/upload-artifact@v4
        name: Upload build artifacts
        with:
          name: windows-binaries
          path: release/

  package-windows:
    name: Package Windows

    runs-on: windows-latest
    needs: build-windows

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        name: Checkout repository
      - uses: dtolnay/rust-toolchain@stable
        name: Set up toolchain
      - uses: Swatinem/rust-cache@v2
        name: Cache cargo-packager
        with:
          cache-targets: false
          cache-directories: ~/.cargo/bin
      - uses: actions/download-artifact@v4
        name: Download build artifacts
        with:
          name: windows-binaries
          path: target/release/
      - name: Download wintun
        run: |
          Invoke-WebRequest https://www.wintun.net/builds/wintun-0.14.1.zip -OutFile $env:TEMP\wintun.zip
          Expand-Archive $env:TEMP\wintun.zip -DestinationPath $env:TEMP\wintun -Force
          cp $env:TEMP\wintun\wintun\bin\amd64\wintun.dll target/release/
      - name: Create zip archive
        run: |
          mkdir ./release
          cp target/release/* release/
          Compress-Archive -Path release/* -DestinationPath quincy-${{ github.ref_name }}-windows-x86_64.zip
      - name: Install cargo-packager
        run: cargo install cargo-packager --locked
      - name: Inject version into packager config
        run: |
          $VERSION = (cargo metadata --format-version 1 --no-deps | ConvertFrom-Json).packages | Where-Object { $_.name -eq "quincy-gui" } | Select-Object -ExpandProperty version
          (Get-Content packager.windows.toml) -replace 'version = "0.0.0"', "version = `"$VERSION`"" | Set-Content packager.windows.toml
      - name: Package Windows installer
        run: cargo packager --release -c packager.windows.toml
        env:
          SKIP_BUILD: "1"
          SKIP_WINTUN: "1"
      - name: Collect artifacts
        run: |
          mkdir artifacts
          Move-Item quincy-${{ github.ref_name }}-windows-x86_64.zip artifacts/
          Move-Item target/release/*-setup.exe artifacts/quincy-${{ github.ref_name }}-windows-x86_64-setup.exe
      - uses: softprops/action-gh-release@v1
        name: Add artifacts to release
        with:
          files: artifacts/*

  build-docker-image:
    name: Build Docker image

    runs-on: ubuntu-latest

    steps:
      - uses: docker/setup-qemu-action@v3
        name: Set up QEMU
      - uses: docker/setup-buildx-action@v3
        name: Set up Docker Buildx
      - uses: docker/login-action@v3
        name: Login to Docker Hub
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - uses: docker/build-push-action@v6
        name: Build and push
        with:
          push: true
          platforms: linux/amd64,linux/arm64
          build-args: |
            FEATURES=jemalloc
          tags: |
            ${{ vars.DOCKERHUB_USERNAME }}/quincy:${{ github.ref_name }}
            ${{ vars.DOCKERHUB_USERNAME }}/quincy:latest
